/*!
 * CirebonWeb (https://cirebonweb.com)
 * Copyright (c) 2023 CirebonWeb
 * Licensed under MIT (https://opensource.org/licenses/MIT)
 */
let baseUrl=window.location.href;window.Lokasi={urlSimpan:`${baseUrl}/simpan`,urlTabel:`${baseUrl}/tabel`,urlHapus:`${baseUrl}/hapus`,urlHapusExpired:`${baseUrl}/hapus-expired`};const $tabelData=$("#tabel-data");TabelHelper.tabelDinamis($tabelData,Lokasi.urlTabel,[{extend:"excelHtml5",text:"Excel",exportOptions:{columns:":visible:not(:eq(6))"}},{text:"Clear",attr:{id:"btn-delete-expired"}}],[{targets:0,width:"5%"},{targets:[0,7],className:"dt-body-center"},{targets:[2,3,4],className:"dt-body-right"},{targets:"_all",className:"dt-head-center"},{targets:[5,6,7],orderable:!1},{targets:[0,2,3,4,5,6,7],searchable:!1}],[[0,"asc"]],{initComplete:function(){let api=this.api(),filterContainer=$("#tabel-data_filter"),extraFilters=$('<div class="ml-2 d-inline-block"></div>');api.columns(1).every((function(){let column=this,headerText=$(column.header()).text().trim(),select=$('<select class="form-control form-control-sm d-inline-block w-auto mr-1"><option value=""># '+headerText+"</option></select>").appendTo(extraFilters).on("change",(function(){let val=$.fn.dataTable.util.escapeRegex($(this).val());column.search(val?"^"+val+"$":"",!0,!1).draw()}));column.data().unique().sort().each((function(d){let text=$("<div>").html(d).text().trim();select.append('<option value="'+text+'">'+text+"</option>")}))})),filterContainer.append(extraFilters)}}),$(document).ready((function(){function updateMenitLabel($input){const detik=parseInt($input.val(),10),$menitLabel=$input.closest(".input-group").find(".menit");if(0===detik)$menitLabel.text("Lifetime");else{const menit=Math.round(detik/60);$menitLabel.text(menit+" menit")}}$('input[type="number"]').each((function(){updateMenitLabel($(this))})),$('input[type="number"]').on("input change",(function(){updateMenitLabel($(this))}))})),$((function(){let $formId=$("#cache-form"),$btnSubmit=$("#cache-submit"),$btnLoading=$("#cache-loading");$btnLoading.hide();let formCek=FormHelper.cekFormData($formId);$formId.validate($.extend(FormHelper.validasiForm(),{ignore:[],rules:{cache_geoip:{required:!0,digits:!0},cache_device:{required:!0,digits:!0},statistik_user_list:{required:!0,digits:!0},statistik_user_login:{required:!0,digits:!0},statistik_log_email:{required:!0,digits:!0}},submitHandler:function(form){return $formId.find(":input").removeClass("is-invalid is-valid"),!!formCek.isChanged()&&FormHelper.submitForm(form,Lokasi.urlSimpan,$btnSubmit,$btnLoading,{formCek:formCek})}}))})),$(document).on("click",".btn-delete",(function(e){e.preventDefault();let filename=$(this).data("filename");Swal.fire({title:"Konfirmasi",text:"Hapus file: "+filename,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33"}).then((result=>{result.isConfirmed&&fetch(Lokasi.urlHapus,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({filename:filename})}).then((async response=>{let res;try{res=await response.json()}catch(e){throw new Error("Respon server tidak valid.")}if(!response.ok||!res.success)throw new Error(res?.messages||"Gagal menghapus file.");Swal.fire("Berhasil",res.messages,"success").then((()=>{$tabelData.DataTable().ajax.reload(null,!1)}))})).catch((error=>{Swal.fire("Error",error.message||"Terjadi kesalahan...","error")}))}))})),$(document).on("click","#btn-delete-expired",(function(e){e.preventDefault(),Swal.fire({title:"Konfirmasi",text:"Hapus semua file cache yang sudah expired?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33"}).then((result=>{result.isConfirmed&&fetch(Lokasi.urlHapusExpired,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}}).then((async response=>{let res;try{res=await response.json()}catch(e){throw new Error("Respon server tidak valid.")}if(!response.ok||!res.success)throw new Error(res?.messages||"Gagal menghapus file expired.");Swal.fire("Berhasil",res.messages,"success").then((()=>{$tabelData.DataTable().ajax.reload(null,!1)}))})).catch((error=>{Swal.fire("Error",error.message||"Terjadi kesalahan...","error")}))}))}));